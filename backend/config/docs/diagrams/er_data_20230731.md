# ER-Diagram of SQL implementation 
updated 2023-07-31, Andreas U Lindner

## 2023-07-31

### .env configuration

#### PostgreSQL

The variables ```datadir``` and ```featurefile``` will be removed since the content will be moved to the database long-term.

* ```n_max_dataset_cached``` - integer, indicates how many datasets are cached.
* ```db-handler``` - The value ```postgresql``` indicates that the postgresql database should be used.
* ```db-ip``` - IP address to the database. Use an IP instead of a name for faster performance.
* ```db-name``` - Name of the database.
* ```db-user``` - PostgreSQL user of the database.
* ```db-pw``` - Password of the PostgreSQL user.

```
token-datadir=/home/andreaslindner/Projects/Major/Immuscience/mitcube_backend/data/dynamic/tokens

db-n_max_dataset_cached = 100
db-featurefile=/home/andreaslindner/Projects/Major/Immuscience/mitcube_backend/data/static/dbs/uniprot/features.txt

db-handler=postgresql
db-ip=127.0.0.1
db-name=ImmunoCubeV2
db-user=immunocube
db-pw=secret
```

#### PandaFile

* ```n_max_dataset_cached``` - integer, indicates how many datasets are cached.
* ```db-handler``` - The ```pandafiles``` indicates that files are used to save and load the data.
* ```db-datadir``` - Directory to the folder which will hold the dataset.
* ```db-featurefile``` - Path to the CSV file with the Protein Database (Protein names, etc.)
* ```db-attributefile``` - Path to JSON files that defines available ```attributes``` and ```attribute values```.
* ```token-datadir``` - Path to directory that will save the tokens.

```
db-n_max_dataset_cached = 100

db-handler=pandafiles
db-datadir=/home/andreaslindner/Projects/Major/Immuscience/mitcube_backend/data/static/datasets
db-featurefile=/home/andreaslindner/Projects/Major/Immuscience/mitcube_backend/data/static/dbs/uniprot/features.txt
db-attributefile=/home/andreaslindner/Projects/Major/Immuscience/mitcube_backend/data/static/attributes.json
token-datadir=/home/andreaslindner/Projects/Major/Immuscience/mitcube_backend/data/dynamic/tokens
```

### PostgreSQL

The column ```dataset_id``` was added to the table ```measurement_values``` to allow grouping without (expensive) joins with ```measurements``` and ```datasets```.

```plantuml
@startuml

entity "oi" {
  * **id** : bigserial <<PK>>
  --
  * label: varchar <<UNIQUE>>
  * type : OI_TYPE
}

entity "measurement_values" as mv {
  * dataset_id : bigint <<FK>>
  * measurement_id : bigint <<FK>>
  * oi_id : bigint <<FK>>
  --
  * value : float
}

entity "measurements" as m {
  * **id** : bigserial <<PK>>
  * dataset_id : bigint <<FK>>
  --
  *label: varchar
}

entity "urls" {
  * **id** : bigserial <<PK>>
  * dataset_id : bigint <<FK>>
  --
  * url: varchar
}

entity "metatexts" as meta {
  * **id** : bigserial <<PK>>
  * dataset_id : bigint <<FK>>
  --
  * tag: varchar
  * title: varchar
  * text: varchar
}

entity "instruments" as int {
  * **id** : serial <<PK>>
  --
  * label: varchar
  * name: varchar
  * description: varchar
}

entity "attributes" as att {
    * **id**: bigint <<PK>>
    * **parent_id**: bigint <<FK>>
    --
    * tag: varchar <<UNIQUE>>
    * name: varchar 
    * priority: int
    * allow_as_filter: bool
    * allow_for_dataset: bool
    * allow_for_measurement: bool
    * allow_for_users: bool
    * allow_for_qc: bool
}

entity "attribute_values" as attv {
    * **id**: bigint <<PK>>
  * attribute_id : bigint <<FK>>
    --
    * tag: varchar <<UNIQUE>>
    * tag: name <<UNIQUE>>
    * tag: details 
}

entity "nm_dataset_attribute_value" as nm_ds_attv {
    * **attribute_value_id**: bigint <<PK>> <<FK>>
    * **dataset_id** : bigint <<PK>> <<FK>>
}

entity "nm_measurement_attribute_value" as nm_m_attv {
    * **attribute_value_id**: bigint <<PK>> <<FK>>
    * **measurement_id** : bigint <<PK>> <<FK>>
}

entity "datasets" as ds {  
  * **id** : bigserial <<PK>>
  * instrument_id : bigint <<FK>>
  --
  * label: varchar <<UNIQUE>>
  * created_on: timestamp
  * uploaded_on: timestamp
  * state: varchar  
  * experimentator: varchar
  * contact_email: varchar
  * name_group: varchar
  * title: varchar
}

mv }|.. oi
m ..|{ mv
ds ..|{ m
ds ..|{ urls
ds ..|{ meta
ds }|.. int

att ..|{ att
att ..|{ attv

attv ..|{ nm_ds_attv
ds ..|{ nm_ds_attv

attv ..|{ nm_m_attv
m ..|{ nm_m_attv

@enduml
```

### QC

Table ```qc``` is due to change.

The properties ```Liquid Chromatography```, ```Acquisition Mode```, ```Column Length``` and ```FAIMS CV``` are stored over the ```attributes``` and ```attribute_value``` tables.

The property ```Mass Spectrometer``` is saved using the ```instruments```.

```plantuml
@startuml


entity "instruments" as int {
  * **id** : serial <<PK>>
  --
  * label: varchar
  * name: varchar
  * description: varchar
}

entity "attributes" as att {
    * **id**: bigint <<PK>>
    * **parent_id**: bigint <<FK>>
    --
    * tag: varchar <<UNIQUE>>
    * name: varchar 
    * priority: int
    * allow_as_filter: bool
    * allow_for_dataset: bool
    * allow_for_measurement: bool
    * allow_for_users: bool
    * allow_for_qc: bool
}

entity "attribute_values" as attv {
    * **id**: bigint <<PK>>
  * attribute_id : bigint <<FK>>
    --
    * tag: varchar <<UNIQUE>>
    * tag: name <<UNIQUE>>
    * tag: details 
}

entity "nm_qc_attribute_value" as nm_qc_attv {
    * **attribute_value_id**: bigint <<PK>> <<FK>>
    * **qc_id** : bigint <<PK>> <<FK>>
}

entity qc { 
  * **id** : bigserial  <<PK>>
  * instrument_id <<FK>>
  --
  * added_on: timestamp 
  * performed_on: timestamp 
  * name_user: varchar 
  * filename_raw: varchar 
  * metric_n_precursors : int
  * metric_n_proteins : int
  * metric_fwhm_rt : float
  * metric_ms2_median_mass_acc : float
  * metric_ms2_mass_instability : float
  * distributions_cscore : float
  * distributions_length_peak : float
  * distributions_median_corr_fragmentation : float
  * peptides_retention_time_LGGNEQVT : float
  * peptides_length_peak_LGGNEQVT : float
  * peptides_retention_time_YKILAGVENS: float
  * peptides_length_peak_YKILAGVENS : float
  * peptides_retention_time_GTFIIDPGGVIR : float
  * peptides_length_peak_GTFIIDPGGVIR : float
  * peptides_retention_time_GAGSSEPVTGLDAK : float
  * peptides_length_peak_GAGSSEPVTGLDAK : float
  * peptides_retention_time_TPVISGGPYEYR : float
  * peptides_length_peak_TPVISGGPYEYR : float
  * peptides_retention_time_VEATFGVDESNAK : float
  * peptides_length_peak_VEATFGVDESNAK : float
  * peptides_retention_time_TPVITGAPYEYR : float
  * peptides_length_peak_TPVITGAPYEYR : float
  * peptides_retention_time_DGLDAASYYAPVR : float
  * peptides_length_peak_DGLDAASYYAPVR : float
  * peptides_retention_time_ADVTPADFSEWSK : float
  * peptides_length_peak_ADVTPADFSEWSK : float
  * peptides_retention_time_LFLQFGAQGSPFLK : float
  * peptides_length_peak_LFLQFGAQGSPFLK : float
  * comments : text
}

att ..|{ att
att ..|{ attv
int ..|{ qc

attv ..|{ nm_qc_attv
qc ..|{ nm_qc_attv

@enduml
```

### Security

Tables ```sec_tokens``` and ```sec_users``` are due to change.


```plantuml
@startuml

entity "attributes" as att {
    * **id**: bigint <<PK>>
    * **parent_id**: bigint <<FK>>
    --
    * tag: varchar <<UNIQUE>>
    * name: varchar 
    * priority: int
    * allow_as_filter: bool
    * allow_for_dataset: bool
    * allow_for_measurement: bool
    * allow_for_users: bool
    * allow_for_qc: bool
}

entity "attribute_values" as attv {
    * **id**: bigint <<PK>>
  * attribute_id : bigint <<FK>>
    --
    * tag: varchar <<UNIQUE>>
    * tag: name <<UNIQUE>>
    * tag: details 
}

entity "nm_user_attribute_value" as nm_u_attv {
    * **attribute_value_id**: bigint <<PK>> <<FK>>
    * **user_id** : bigint <<PK>> <<FK>>
}

entity "sec_users" as u {  
  * **user_id** : bigserial <<PK>>
  --
  * user_hash : varchar <<UNIQUE>>
  * user_name : varchar <<UNIQUE>>
  * user_firstname: varchar 
  * user_surname: varchar 
  * email: varchar <<UNIQUE>>
  * salt: varchar 
  * password: varchar 
  * created_on: timestamp 
  * expires_after: timestamp 
  * allow_login: bool 
}

entity "sec_token" as t {  
  --
  * token : varchar <<UNIQUE>>
  * is_user_token : bool
  * valid_till: timestamp 
  * validated : bool
  * validation_code: varchar 
  * superadmin : bool
  * shared_token : bool
}

att ..|{ att
att ..|{ attv

attv ..|{ nm_u_attv
u ..|{ nm_u_attv

@enduml
```

### JSON (PandaFile)

#### Class Json

Representation of the JSON object within the ```MCDataset``` class used for Metadata that is also 
saved one-to-one to a JSON file if ```MCPandaDataset``` is used. 

```plantuml
@startjson
{
    "id": "[0-9]+",
    "label": "[0-9a-Z_]+",
    "state": "[0-9a-Z_]+",
    "title": "[0-9a-Z_ ]+",
    "experimentator": "[0-9a-Z_ ]+",
    "group_name": "[0-9a-Z_ ]+",
    "email": "[0-9a-Z_.]+@[0-9a-Z_.]+",
    "date_created_on": "YYYY-MM-DD HH:MM:SS",
    "date_uploaded_on": "YYYY-MM-DD HH:MM:SS",
    "instrument": {
        "id": "[0-9]+",
        "label": "[0-9a-Z_]+",
        "name": "[0-9a-Z_]+",
        "description": "text"},
    "n_rows": "[0-9]+",
    "n_samples": "[0-9]+",
    "metatexts": [
        {
            "id": "[0-9]+",
            "tag": "[0-9a-Z_]+",
            "title": "[0-9a-Z_]+",
            "text": "text"} ],
    "urls": ["http://example.de", "http://confluence.edu", "http://other.example.org", "..."],
    "replicates": {
        "A" : ["SampleA1", "SampleA2", "..."], 
        "B": ["SampleB1", "SampleB2", "..."],
        "...": ""},
    "attributes": {
        "att_example:something": {
            "attribute_id": "[0-9]+",
            "attribute_parent_id": "None|([0-9]+)",
            "attribute_tag": "att_[0-9a-Z_]+, e.g. att_example",
            "attribute": "[0-9a-Z_]+",
            "priority": "[0-9]+",
            "allow_as_filter": "TRUE|FALSE",
            "id": "[0-9]+",
            "tag": "att_[0-9a-Z_]+:[0-9a-Z_]+, e.g. att_example:something",
            "value": "[0-9a-Z_ ]+",
            "details": "text"},
            "att_organism:human": "",
            "att_substance:DMSO": "",
            "...": ""},
    "n_attributes": "[0-9]+",
    "group_attributes": {
        "att_example": {
            "attribute_id": "[0-9]+",
            "attribute_parent_id": "None|([0-9]+)",
            "attribute": "[0-9a-Z_]+",
            "priority": "[0-9]+",
            "allow_as_filter": "TRUE|FALSE",
            "values": {
                "att_example:something": {
                    "id": "[0-9]+",
                    "tag": "att_[0-9a-Z_]+:[0-9a-Z_]+, e.g. att_example:something",
                    "value": "[0-9a-Z_]+",
                    "details": "text",
                    "samples": ["Sample1", "Sample2", "..."]},
                   "att_example:other": "",
                   "...": ""}
            },
        "att_organism": "",
        "...": ""
        },
    "n_group_attributes": "[0-9]+"
}
@endjson
```

#### Panda Configuration 

If not defined in the SQL database and ```PandaFileDatabase``` is used, definitions of 
```attributes``` and ```attribute_values``` are saved in the file ```attributes.json``` in the
```./backend/data/static/dbs/``` directory.

It is required to link the file using the ```.env``` and the ```db-attributefile``` parameter.

```plantuml
@startjson
{
	"attributes": [
		{"id": 12, "parent_id": null, "tag": "att_mockup", "name": "Mockup", "priority": 0, "allow_as_filter": false, "allow_for_dataset": false, "allow_for_measurement": true, "allow_for_users": false, "allow_for_qc": false}, 
		{"id": 13, "parent_id": null, "tag": "att_organism", "name": "Organism", "priority": 500, "allow_as_filter": true, "allow_for_dataset": true, "allow_for_measurement": true, "allow_for_users": false, "allow_for_qc": false},
		"..." 
	], 
	"attribute_values": [
		{"id": 54, "attribute_id": 12, "tag": "att_mockup:random", "name": "Random", "details": "Mock category that may was randomly assigned."}, 
		{"id": 55, "attribute_id": 12, "tag": "att_mockup:arbitrary", "name": "Arbitrary", "details": "Mock category that may was randomly assigned."},
		{"id": 56, "attribute_id": 13, "tag": "att_organism:other", "name": "Other/Multiple", "details": "Other/Multiple (Specify in Additional Info)"}, 
		{"id": 57, "attribute_id": 13, "tag": "att_organism:human", "name": "Homo sapiens", "details": "Homo sapiens (Human)"}, 
		{"id": 58, "attribute_id": 13, "tag": "att_organism:mouse", "name": "Mus musculus", "details": "Mus musculus (Mouse)"}, 
		{"id": 59, "attribute_id": 13, "tag": "att_organism:rat", "name": "Rattus norvegicus", "details": "Rattus norvegicus (Rat)"}, 
		{"id": 60, "attribute_id": 13, "tag": "att_organism:elegans", "name": "Caenorhabditis elegans", "details": "Caenorhabditis elegans"}, 
		{"id": 61, "attribute_id": 13, "tag": "att_organism:gut_biom", "name": "Gut Microbiom", "details": "Gut Microbiomm (Specify in Additional Info)"}, 
		{"id": 62, "attribute_id": 13, "tag": "att_organism:yeast", "name": "Saccharomyces cerevisiae", "details": "Saccharomyces cerevisiae (Baker's Yeast)"},
		"..." 
	]
}
@endjson
```
